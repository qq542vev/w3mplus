#!/usr/bin/env sh

## File: w3m-private
##
## Start w3m in private mode.
##
## Cache files, temporary files, cookies, and history are deleted when w3m ends.
##
## Usage:
##
##   (start code)
##   w3m-private [--exclude PATTERN] [W3MARG]...
##   (end)
##
## Options:
##
##   --exclude - files not shared with profiles.
##
## Exit Status:
##
##   0 - Program terminated normally.
##   64<= and <=78 - Program terminated abnormally. See </usr/include/sysexits.h> for the returned value.
##
## Metadata:
##
##   author - qq542vev <https://purl.org/meta/me/>
##   version - 1.1.0
##   date - 2020-02-24
##   copyright - Copyright (C) 2019-2020 qq542vev. Some rights reserved.
##   license - CC-BY <https://creativecommons.org/licenses/by/4.0/>
##   package - w3mplus
##
## See Also:
##
##   * Project homepage - <https://github.com/qq542vev/w3mplus>
##   * Bag report - <https://github.com/qq542vev/w3mplus/issues

# 初期化
set -efu
umask '0022'
IFS=$(printf ' \t\n$'); IFS="${IFS%$}"
export 'IFS'

# initファイルの読み込み
: "${W3MPLUS_PATH:=${HOME}/.w3m/w3mplus}"
. "${W3MPLUS_PATH}/lib/w3mplus/init"

exclude='./cookie ./w3mcache* ./w3mcookie* ./w3mframe* ./w3msrc* ./w3mtmp*'
awkScript=$(cat <<- 'EOF'
	BEGIN {
		output = ""
	}

	{
		for(i = 1; i <= NF; i++) {
			if(output) {
				output = output " -o "
			}

			gsub(/'+/, "'\"&\"'", $i)
			output = output sprintf("-path %s", $i)
		}
	}

	END {
		if(output) {
			printf("! ( ( %s ) -prune )", output)
		}
	}
EOF
)

if [ "${1-}" = '--exclude' ]; then
	exclude="${2}"
fi

expression=$(printf '%s' "${exclude}" | awk "${awkScript}")

tmpDir=$(mktemp -d)
mkdir -p -- "${tmpDir}/.w3m"

(
	cd "${HOME}/.w3m"

	find -L -- '.' ${expression} -type d -exec 'mkdir' '-p' "${tmpDir}/.w3m/{}" ';'
	find -L -- '.' ${expression} -type f -exec 'cp' '-fp' '{}' "${tmpDir}/.w3m/{}" ';'

	if [ -e "${tmpDir}/.w3m/bookmark.html" ]; then
		ln -fs -- "${HOME}/.w3m/bookmark.html" "${tmpDir}/.w3m/bookmark.html"
	else
		cat >"${tmpDir}/.w3m/bookmark.html" <<- 'EOF'
			<html><head><title>Bookmarks</title></head>
			<body>
			<h1>Bookmarks</h1>
			<h2>Unsorted Bookmarks</h2>
			<ul>
			<!--End of section (do not delete this comment)-->
			</ul>
			</body>
			</html>
		EOF
	fi
)

HOME="${tmpDir}" w3m ${@+"${@}"}
