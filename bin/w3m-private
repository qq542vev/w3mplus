#!/usr/bin/env sh

# 初期化
set -eu
umask 0022
IFS=$(printf ' \t\n$'); IFS="${IFS%$}"
export 'IFS'

# 終了時に一時ディレクトリを削除する
endcall () {
	rm -fr "${tmpDir}"
}

exclude='\./(cookie|w3m(cache|cookie|src|tmp).*)'

if [ "${1-}" = '--exclude' ]; then
	exclude="${2-}"
	shift 2
fi

tmpDir=$(mktemp -d)

# 終了時の動作を設定する
trap 'endcall' 0 # EXIT
trap 'exit 129' 1 # SIGHUP
trap 'exit 130' 2 # SIGINT
trap 'exit 131' 3 # SIGQUIT
trap 'exit 143' 15 # SIGTERM

mkdir -p "${tmpDir}/.w3m"
(
	cd "${HOME}/.w3m"

	find '.' -mindepth '1' -maxdepth '1' -regextype 'posix-egrep' '!' -regex "${exclude}" -execdir 'cp' '-a' '{}' "${tmpDir}/.w3m" ';'

	if [ -e "${tmpDir}/.w3m/bookmark.html" ]; then
		ln -fs "${HOME}/.w3m/bookmark.html" "${tmpDir}/.w3m/bookmark.html"
	else
		cat >"${tmpDir}/.w3m/bookmark.html" <<- 'EOF'
<html><head><title>Bookmarks</title></head>
<body>
<h1>Bookmarks</h1>
<h2>Unsorted Bookmarks</h2>
<ul>
<!--End of section (do not delete this comment)-->
</ul>
<h2>w3m</h2>
<ul>
<li><a href="http://w3m.sourceforge.net/">W3M Homepage</a>
<li><a href="https://github.com/tats/w3m">GitHub - tats/w3m: Debian's w3m: WWW browsable pager</a>
<li><a href="http://pub.ks-and-ks.ne.jp/prog/w3mmee/">w3m-mee</a>
<li><a href="http://emacs-w3m.namazu.org/">Emacs-w3m</a>
<!--End of section (do not delete this comment)-->
</ul>
</body>
</html>
		EOF
	fi
)

HOME="${tmpDir}" w3m ${@+"${@}"}
