#!/usr/bin/env sh

##
# Display the response for w3m.
#
# @author qq542vev
# @version 1.2.0
# @date 2020-02-13
# @licence https://creativecommons.org/licenses/by/4.0/
##

# 初期化
set -efu
umask '0022'
IFS=$(printf ' \t\n$'); IFS="${IFS%$}"
export 'IFS'

# initファイルの読み込み
: "${W3MPLUS_PATH:=${HOME}/.w3m/w3mplus}"
. "${W3MPLUS_PATH}/lib/w3mplus/init"

# 終了時に一時ファイルを削除する
endCall () {
	rm -f -- ${query_file+"${query_file}"}
}

expand () (
	if expr -- "${1}" ':' '${[_A-Za-z][_0-9A-Za-z]*}$' >'/dev/null'; then
		eval printf '%s' "\"${1}\""
	else
		printf '%s' "${1}"
	fi
)

addPrintCache () (
	tmpPath=$(mktemp -u)

	httpResponseW3mBack.sh <<- EOF
		W3m-control: PRINT ${tmpPath}
		W3m-control: GOTO file://${SCRIPT_NAME}?${QUERY_STRING}${QUERY_STRING:+&}file=$(printf '%s' "${tmpPath}" | urlencode)
	EOF
)

eval "$(printf '%s' "${QUERY_STRING-}" | parseQuery.sh --prefix 'query_')"

if [ -n "${query_redirect-}" ]; then
	W3MPLUS_REDIRECT_TYPE="${query_redirect}"
	export 'W3MPLUS_REDIRECT_TYPE'
fi

if result=$(
	case "${query_action-}" in
		'autoCommand')
			string=$(expand "${query_string-\${W3M_URL\}}")

			getAutoCommand.sh -- "${query_call-manual}" ${string:+"${string}"}
			;;
		'closeTab')
			if [ -n "${W3M_URL}" ]; then
				closeTab.sh --line "${W3M_CURRENT_LINE}" --colmun "${W3M_CURRENT_COLUMN}" -- "${W3M_URL}"
			fi

			printf 'W3m-control: CLOSE_TAB' | httpResponseW3mBack.sh -
			;;
		'undoTab')
			case "${query_count-}" in '@'*)
				query_number="@$(date -u '+%Y%m%d%H%M%S' | TZ='UTC+0' utconv)"
			esac

			undoTab.sh ${query_number+'--number' "${query_number}"} ${query_count+'--count' "${query_count}"} | awk '{
				printf("W3m-control: TAB_GOTO %s\n", $1)
				printf("W3m-control: GOTO_LINE %d\n", $2)
			}' | httpResponseW3mBack.sh -
			;;
		'undoTabs')
			: >>"${W3MPLUS_PATH}/tabRestore"

			printRedirect.sh "file://$(urlencodeForPath "${W3MPLUS_PATH}")/tabRestore"
			;;
		'homepage')
			printRedirect.sh "${WWW_HOME-about:home}"
			;;
		'aboutURI')
			aboutURI.sh ${query_uri+"${query_uri}"}
			;;
		'moveColmun')
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -f "${query_file-}" ]; then
				moveColmun.sh --line "${line}" ${query_percent+'--number' "${query_percent}"} --skip -- "${query_file}"
			else
				addPrintCache
			fi
			;;
		'moveParagraph')
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -f "${query_file-}" ]; then
				moveParagraph.sh --line "${line}" ${query_number+'--number' "${query_number}"} -- "${query_file}"
			else
				addPrintCache
			fi
			;;
		'movePercent')
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -f "${query_file-}" ]; then
				movePercent.sh --line "${line}" ${query_percent+'--number' "${query_percent}"} -- "${query_file}"
			else
				addPrintCache
			fi
			;;
		'stringFind')
			word=$(expand "${query_word-\${W3M_CURRENT_WORD\}}")

			find.sh ${query_number+'--number' "${query_number}"} -- "${word}"
			;;
		'wordFind')
			word=$(expand "${query_word-\${W3M_CURRENT_WORD\}}")

			find.sh --exact ${query_number+'--number' "${query_number}"} -- "${word}"
			;;
		'qmarks')
			: >>"${W3MPLUS_PATH}/quickmark"

			printRedirect.sh "file://$(urlencodeForPath "${W3MPLUS_PATH}")/quickmark"
			;;
		'getQuickMark')
			getQuickMark.sh -- ${query_key+"${query_key}"}
			;;
		'setQuickMark')
			uri=$(expand "${query_uri-\${W3M_URL\}}")
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -n "${uri}" ]; then
				setQuickMark.sh --line "${line}" -- "${query_key}" "${uri}"
			fi
			;;
		'marks')
			: >>"${W3MPLUS_PATH}/localmark"

			printRedirect.sh "file://$(urlencodeForPath "${W3MPLUS_PATH}")/localmark"
			;;
		'getLocalMark')
			getAutoCommand.sh --config "${W3MPLUS_PATH}/localmark" -- "${query_key}" "${W3M_URL%%#*}"
			;;
		'setLocalMark')
			uri=$(expand "${query_uri-\${W3M_URL\}}")
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -n "${uri}" ]; then
				setAutoCommand.sh --config "${W3MPLUS_PATH}/localmark" -- "${query_key}" "grep -Fx -e '$(printf '%s' "${uri%%#*}" | sed -e "s/'\\{1,\\}/'\"&\"'/g")'" "GOTO_LINE ${line}"
			fi
			;;
		'getLocalMarkGoto')
			getQuickMark.sh --config "${W3MPLUS_PATH}/localmarkGoto" --line -- ${query_key+"${query_key}"}
			;;
		'setLocalMarkGoto')
			uri=$(expand "${query_uri-\${W3M_URL\}}")
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -n "${uri}" ]; then
				setQuickMark.sh --config "${W3MPLUS_PATH}/localmarkGoto" --line "${line}" -- "${query_key}" "${uri}"
			fi
			;;
		'contextMenu')
			contextMenu.sh
			;;
		'linkSetOpen')
			if [ -n "${W3M_CURRENT_LINK}" ]; then
				httpResponseW3mBack.sh - <<- 'EOF'
					W3m-control: SET_OPTION default_url=2
					W3m-control: GOTO
				EOF
			fi
			;;
		'linkSetTabopen')
			if [ -n "${W3M_CURRENT_LINK}" ]; then
				httpResponseW3mBack.sh - <<- 'EOF'
					W3m-control: SET_OPTION default_url=2
					W3m-control: TAB_GOTO
				EOF
			fi
			;;
		'uri')
			uri=$(expand "${query_uri-\${W3M_URL\}}")

			if [ -n "${uri}" ]; then
				location.sh "${query_subaction}" "${uri}"
			fi
			;;
		'lineVisualMode')
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -f "${query_file-}" ]; then
				lineVisualMode.sh --line "${line}" -- "${query_file}"
			else
				addPrintCache
			fi
			;;
		'yank')
			yank=$(expand "${query_yank-\${W3M_URL\}}")

			if [ -n "${yank}" ]; then
				yank.sh -- "${yank}"
			fi
			;;
		'zoom')
			zoom.sh ${query_zoom+'--number' "${query_zoom}"}

			printf 'W3m-control: SET_OPTION image_scale=%d\n' -- "$(awk -- '/^image_scale[	 ]/ { printf("%d", $2); exit }' "${W3MPLUS_W3M_CONFIG}")" | httpResponseW3mBack.sh -
			;;
		'search')
			printRedirect.sh "${W3MPLUS_SEARCH_URI}${query_query-}"
			;;
		'dictWordSearch')
			printRedirect.sh "${W3MPLUS_SEARCH_URI}${query_query#?}"
			;;
		'selectLine')
			line=$(expand "${query_line-\${W3M_CURRENT_LINE\}}")

			if [ -f "${query_file-}" ]; then
				selectLine.sh --line "${line}" ${query_number+'--number' "${query_number}"} -- "${query_subaction}" "${query_file}"
			else
				addPrintCache
			fi
			;;
		'equalPrg')
			if [ -n "${W3MPLUS_EQUALPRG}" ]; then
				if [ -f "${W3M_SOURCEFILE}" ]; then
					w3m -dump "${W3M_SOURCEFILE}" | eval "${W3MPLUS_EQUALPRG}"
				fi
			else
				printHtml.sh --title 'Bad Request' --status-code '400 Bad Request' <<- 'EOF'
					<p>The value of the environment variable <strong><var>W3MPLUS_EQUALPRG</var></strong> is empty.</p>
				EOF
			fi
			;;
		'cookieManager')
			url=$(expand "${query_url-\${W3M_URL\}}")

			if [ -n "${url}" ]; then
				cookieManager.sh ${query_blacklist+'--blacklist' "${query_blacklist}"} ${query_whitelist+'--whitelist' "${query_whitelist}"} ${query_subdomain+'--subdomain'} -- "${url}"
			fi
			;;
		*)
			printHtml.sh --title 'Bad Request' --status-code '400 Bad Request' <<- EOF
				<dl>
					<dt>autoCommand</dt>
					<dd>file://${SCRIPT_NAME}?action=autoCommand&amp;call={call-type}</dd>

					<dt>closeTab</dt>
					<dd>file://${SCRIPT_NAME}?action=closeTab</dd>

					<dt>undoTab</dt>
					<dd>file://${SCRIPT_NAME}?action=undoTab&amp;number={number}</dd>

					<dt>undoTabs</dt>
					<dd>file://${SCRIPT_NAME}?action=undoTabs</dd>

					<dt>homepage</dt>
					<dd>file://${SCRIPT_NAME}?action=homepage</dd>

					<dt>aboutURI</dt>
					<dd>file://${SCRIPT_NAME}?action=aboutURI&amp;uri={about-uri}</dd>

					<dt>moveColmun</dt>
					<dd>file://${SCRIPT_NAME}?action=moveColmun&amp;number={number}&amp;file={file}</dd>

					<dt>moveParagraph</dt>
					<dd>file://${SCRIPT_NAME}?action=moveParagraph&amp;number={number}&amp;file={file}</dd>

					<dt>movePercent</dt>
					<dd>file://${SCRIPT_NAME}?action=movePercent&amp;percent={percent}&amp;file={file}</dd>

					<dt>stringFind</dt>
					<dd>file://${SCRIPT_NAME}?action=stringFind&number={number}</dd>

					<dt>wordFind</dt>
					<dd>file://${SCRIPT_NAME}?action=wordFind&number={number}</dd>

					<dt>qmarks</dt>
					<dd>file://${SCRIPT_NAME}?action=qmarks</dd>

					<dt>getQuickMark</dt>
					<dd>file://${SCRIPT_NAME}?action=getQuickMark&amp;key={key}</dd>

					<dt>setQuickMark</dt>
					<dd>file://${SCRIPT_NAME}?action=setQuickMark&amp;key={key}</dd>

					<dt>marks</dt>
					<dd>file://${SCRIPT_NAME}?action=marks</dd>

					<dt>getLocalMark</dt>
					<dd>file://${SCRIPT_NAME}?action=getLocalMark&amp;key={key}</dd>

					<dt>setLocalMark</dt>
					<dd>file://${SCRIPT_NAME}?action=setLocalMark&amp;key={key}</dd>

					<dt>getLocalMarkGoto</dt>
					<dd>file://${SCRIPT_NAME}?action=getLocalMarkGoto&amp;key={key}</dd>

					<dt>setLocalMarkGoto</dt>
					<dd>file://${SCRIPT_NAME}?action=setLocalMarkGoto&amp;key={key}</dd>

					<dt>contextMenu</dt>
					<dd>file://${SCRIPT_NAME}?action=contextMenu</dd>

					<dt>uri</dt>
					<dd>file://${SCRIPT_NAME}?action=uri&subaction={addBookmark|parentPath|prevTab|sendEmail|viewSource|viewSourceExternally|yank}</dd>

					<dt>lineVisualMode</dt>
					<dd>file://${SCRIPT_NAME}?action=lineVisualMode</dd>

					<dt>yankSelection</dt>
					<dd>file://${SCRIPT_NAME}?action=yankSelection</dd>

					<dt>zoom</dt>
					<dd>file://${SCRIPT_NAME}?action=zoom&amp;zoom={number}</dd>

					<dt>search</dt>
					<dd>file://${SCRIPT_NAME}?action=search&amp;query={query}</dd>

					<dt>dictWordSearch</dt>
					<dd>file://${SCRIPT_NAME}?action=dictWordSearch&amp;query={query}</dd>

					<dt>selectLine</dt>
					<dd>file://${SCRIPT_NAME}?action=selectLine&amp;subaction={subaction}&amp;number={number}&amp;file={file}</dd>

					<dt>equalPrg</dt>
					<dd>file://${SCRIPT_NAME}?action=equalPrg</dd>
				</dl>
			EOF
			;;
	esac 2>&1

	printf '$'
); then
	if [ -z "${result%$}" ]; then
		httpResponseW3mBack.sh
	else
		printf '%s' "${result%$}"
	fi
else
	printHtml.sh --title '500 Internal Server Error' --status-code '500 Internal Server Error' <<- EOF
	<p>An unexpected error occurred during request processing.</p>

	<section id="error-message">
		<h1>Error message</h1>

		<pre title="Error Message"><samp>$(printf '%s' "${result}" | htmlEscape.sh)</samp></pre>
	</section>

	<section id="environment-variable">
		<h1>Environment variable</h1>

		<pre title="Environment variable"><code><samp>$(env | htmlEscape.sh)</samp></code></pre>
	</section>
	EOF

	exit 70 # EX_SOFTWARE </usr/include/sysexits.h>
fi
